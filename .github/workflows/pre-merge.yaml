name: Pre-merge Unit Tests

on:
  pull_request:
    branches: [ main, foudation ]
  push:
    branches: [ main, foudation, copilot/** ]
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests with coverage
      id: unit_tests
      run: |
        python -m pytest unit_tests/ -v --tb=short --cov=src --cov=resources/lib --cov-report=term --cov-report=html
        echo "exit_code=$?" >> $GITHUB_OUTPUT
    
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
    
    - name: Parse test results
      if: always()
      id: test_results
      run: |
        # Count test results from pytest output
        if [ -f .coverage ]; then
          TESTS_RUN=$(python -m pytest unit_tests/ --collect-only -q | tail -1 | grep -oP '\d+(?= test)' || echo "0")
          echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
          
          # Check if tests passed
          if [ "${{ steps.unit_tests.outputs.exit_code }}" = "0" ]; then
            echo "summary=âœ… All $TESTS_RUN unit tests passed" >> $GITHUB_OUTPUT
          else
            echo "summary=âŒ Unit tests failed" >> $GITHUB_OUTPUT
          fi
        else
          echo "summary=âš ï¸ No test results found" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment PR with test results
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const summary = '${{ steps.test_results.outputs.summary }}';
          const testsRun = '${{ steps.test_results.outputs.tests_run }}';
          
          let comment = `## ðŸ§ª Pre-merge Unit Tests\n\n`;
          comment += `${summary}\n\n`;
          
          if (testsRun > 0) {
            comment += `**Tests executed:** ${testsRun}\n\n`;
          }
          
          comment += `[View coverage report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Fail if tests failed
      if: steps.unit_tests.outputs.exit_code != '0'
      run: |
        echo "Unit tests failed - blocking merge"
        exit 1
